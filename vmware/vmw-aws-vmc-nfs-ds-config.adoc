---
sidebar: sidebar 
permalink: vmware/vmw-aws-vmc-nfs-ds-config.html 
keywords:  
summary:  
---
= AWS で補足 NFS データストアを作成する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
VMware Cloud の準備が整い、AWS VPC に接続されたら、元の接続済みまたは既存のデフォルト VPC ではなく、新しく指定した VPC にAmazon FSx ONTAPをデプロイする必要があります。

まず、SDDC が存在するのと同じリージョンとアベイラビリティーゾーンに追加の VPC をデプロイし、新しい VPC にAmazon FSx ONTAP をデプロイします。 https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws-networking-security/GUID-C957DBA7-16F5-412B-BB72-15B49B714723.html["VMware Cloud における SDDC グループの構成"^]コンソールは、FSx ONTAPがデプロイされる新しく指定された VPC に接続するために必要なネットワーク構成オプションを有効にします。


NOTE: FSx ONTAP をVMware Cloud on AWS SDDC と同じアベイラビリティーゾーンにデプロイします。


NOTE: 接続された VPC に FSx ONTAPをデプロイすることはできません。代わりに、新しい指定された VPC にデプロイし、SDDC グループを介して VPC を VMware Managed Transit Gateway (vTGW) に接続する必要があります。

.ステップ 1: 新しい指定 VPC にAmazon FSx ONTAPを作成する
[%collapsible%open]
====
Amazon FSx ONTAPファイルシステムを作成してマウントするには、次の手順を実行します。

. Amazon FSxコンソールを開きます `https://console.aws.amazon.com/fsx/`*ファイルシステムの作成*を選択して、*ファイルシステムの作成*ウィザードを開始します。
. [ファイル システム タイプの選択] ページで、* Amazon FSx ONTAP* を選択し、*次へ* をクリックします。  *ファイル システムの作成* ページが表示されます。
+
image:fsx-nfs-002.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 作成方法としては*標準作成*を選択します。
+
image:fsx-nfs-003.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+
image:fsx-nfs-004.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: データストアのサイズは顧客ごとにかなり異なります。 NFS データストアあたりの仮想マシンの推奨数は主観的ですが、各データストアに配置できる仮想マシンの最適な数は多くの要因によって決まります。ほとんどの管理者は容量のみを考慮しますが、VMDK に送信される同時 I/O の量は、全体的なパフォーマンスにとって最も重要な要素の 1 つです。オンプレミスのパフォーマンス統計を使用して、それに応じてデータストアのボリュームのサイズを決定します。

. 仮想プライベートクラウド (VPC) の *ネットワーク* セクションで、適切な VPC と優先サブネット、およびルートテーブルを選択します。この場合、ドロップダウン メニューから Demo- FSxforONTAP-VPC が選択されます。
+

NOTE: これが接続された VPC ではなく、指定された新しい VPC であることを確認してください。

+

NOTE: デフォルトでは、FSx ONTAP はファイルシステムのデフォルトのエンドポイント IP アドレス範囲として 198.19.0.0/16 を使用します。エンドポイント IP アドレス範囲が、AWS SDDC、関連付けられた VPC サブネット、オンプレミス インフラストラクチャ上の VMC と競合しないことを確認します。不明な場合は、競合のない重複しない範囲を使用してください。

+
image:fsx-nfs-005.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 暗号化キーの *セキュリティと暗号化* セクションで、保存中のファイルシステムのデータを保護する AWS Key Management Service (AWS KMS) 暗号化キーを選択します。  *ファイル システム管理パスワード* には、fsxadmin ユーザーの安全なパスワードを入力します。
+
image:fsx-nfs-006.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *デフォルトのストレージ仮想マシン構成*セクションで、SVM の名前を指定します。
+

NOTE: GA 時点では、4 つの NFS データストアがサポートされています。

+
image:fsx-nfs-007.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *デフォルトのボリューム構成*セクションで、データストアに必要なボリューム名とサイズを指定し、*次へ*をクリックします。これは NFSv3 ボリュームである必要があります。 *ストレージ効率* では、*有効* を選択して、 ONTAPストレージ効率機能 (圧縮、重複排除、および圧縮) をオンにします。作成後、シェルを使用して、次のように *_volume modify_* を使用してボリューム パラメータを変更します。
+
[cols="50%, 50%"]
|===
| 設定 | 構成 


| ボリューム保証（スペース保証型） | なし（シンプロビジョニング） – デフォルトで設定 


| 部分準備金（部分準備金） | 0% – デフォルトで設定 


| snap_reserve (スナップショット領域のパーセント) | 0% 


| 自動サイズ調整 (autosize-mode) | grow_shrink 


| ストレージ効率 | 有効 – デフォルトで設定されています 


| 自動削除 | 巻 / 古い順 


| ボリューム階層化ポリシー | スナップショットのみ – デフォルトで設定 


| try_first | 自動拡張 


| スナップショットポリシー | なし 
|===
+
ボリュームを作成および変更するには、次の SSH コマンドを使用します。

+
*シェルから新しいデータストアボリュームを作成するコマンド:*

+
 volume create -vserver FSxONTAPDatastoreSVM -volume DemoDS002 -aggregate aggr1 -size 1024GB -state online -tiering-policy snapshot-only -percent-snapshot-space 0 -autosize-mode grow -snapshot-policy none -junction-path /DemoDS002
+
*注意:* シェル経由で作成されたボリュームが AWS コンソールに表示されるまでには数分かかります。

+
*デフォルトで設定されていないボリュームパラメータを変更するコマンド:*

+
....
volume modify -vserver FSxONTAPDatastoreSVM -volume DemoDS002 -fractional-reserve 0
volume modify -vserver FSxONTAPDatastoreSVM -volume DemoDS002 -space-mgmt-try-first vol_grow
volume modify -vserver FSxONTAPDatastoreSVM -volume DemoDS002 -autosize-mode grow
....
+
image:fsx-nfs-008.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+
image:fsx-nfs-009.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: 初期移行シナリオでは、デフォルトのスナップショット ポリシーにより、データストアの容量不足の問題が発生する可能性があります。これを克服するには、ニーズに合わせてスナップショット ポリシーを変更します。

. *ファイル システムの作成* ページに表示されるファイル システム構成を確認します。
. *ファイルシステムの作成*をクリックします。
+
image:fsx-nfs-010.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+
image:fsx-nfs-011.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: 容量とパフォーマンスの要件に応じて、前の手順を繰り返して、さらにストレージ仮想マシンまたはファイル システムとデータストア ボリュームを作成します。



Amazon FSx ONTAPのパフォーマンスについては、以下を参照してください。 https://docs.aws.amazon.com/fsx/latest/ONTAPGuide/performance.html["Amazon FSx ONTAP のパフォーマンス"^] 。

====
.ステップ2: SDDCグループを作成する
[%collapsible%open]
====
ファイル システムと SVM が作成されたら、VMware コンソールを使用して SDDC グループを作成し、VMware Transit Connect を構成します。これを行うには、次の手順を実行します。VMware Cloud コンソールと AWS コンソール間を移動する必要があることに注意してください。

. VMCコンソールにログインします `https://vmc.vmware.com`。
. *インベントリ*ページで、*SDDC グループ*をクリックします。
. *SDDC グループ* タブで、*アクション* をクリックし、*SDDC グループの作成* を選択します。デモの目的で、SDDCグループは `FSxONTAPDatastoreGrp`。
. [メンバーシップ] グリッドで、グループ メンバーとして含める SDDC を選択します。
+
image:fsx-nfs-012.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 「グループに VMware Transit Connect を構成すると、添付ファイルとデータ転送ごとに料金が発生します」がチェックされていることを確認し、[グループの作成] を選択します。このプロセスは完了するまでに数分かかる場合があります。
+
image:fsx-nfs-013.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



====
.ステップ3: VMware Transit Connectを構成する
[%collapsible%open]
====
. 新しく作成した指定 VPC を SDDC グループに接続します。 *外部VPC*タブを選択し、 https://docs.vmware.com/en/VMware-Cloud-on-AWS/services/com.vmware.vmc-aws-networking-security/GUID-A3D03968-350E-4A34-A53E-C0097F5F26A9.html["外部VPCをグループに接続する手順"^] 。このプロセスは完了するまでに 10 ～ 15 分かかる場合があります。
+
image:fsx-nfs-014.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *アカウントを追加*をクリックします。
+
.. FSx ONTAPファイルシステムのプロビジョニングに使用された AWS アカウントを提供します。
.. *[追加]*をクリックします。


. AWS コンソールに戻り、同じ AWS アカウントにログインして、*Resource Access Manager* サービス ページに移動します。リソース共有を受け入れるためのボタンがあります。
+
image:fsx-nfs-015.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: 外部 VPC プロセスの一環として、AWS コンソールから Resource Access Manager を介して新しい共有リソースへのプロンプトが表示されます。共有リソースは、VMware Transit Connect によって管理される AWS Transit Gateway です。

. *リソース共有を承認*をクリックします。
+
image:fsx-nfs-016.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. VMC コンソールに戻ると、外部 VPC が関連付けられた状態になっていることがわかります。表示されるまで数分かかる場合があります。


====
.ステップ4: トランジットゲートウェイアタッチメントを作成する
[%collapsible%open]
====
. AWS コンソールで、VPC サービスページに移動し、FSx ファイルシステムのプロビジョニングに使用された VPC に移動します。ここでは、右側のナビゲーション ペインで *Transit Gateway Attachment* をクリックして、トランジット ゲートウェイ アタッチメントを作成します。
. *VPC アタッチメント* で、DNS サポートがチェックされていることを確認し、FSx ONTAPがデプロイされている VPC を選択します。
+
image:fsx-nfs-017.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *トランジット ゲートウェイ アタッチメントの作成*をクリックします。
+
image:fsx-nfs-018.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. VMware Cloud コンソールに戻り、[SDDC グループ] > [外部 VPC] タブに戻ります。  FSx に使用する AWS アカウント ID を選択し、VPC をクリックして [承認] をクリックします。
+
image:fsx-nfs-019.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+
image:fsx-nfs-020.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: このオプションが表示されるまで数分かかる場合があります。

. 次に、「*外部 VPC*」タブの「*ルート*」列で、「*ルートの追加*」オプションをクリックし、必要なルートを追加します。
+
** Amazon FSx ONTAPフローティング IP のフローティング IP 範囲のルート。
** 新しく作成された外部 VPC アドレス空間へのルート。
+
image:fsx-nfs-021.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+
image:fsx-nfs-022.png["入出力ダイアログまたは書かれたコンテンツを示す図"]





====
.ステップ5: ルーティング（AWS VPCとSDDC）とセキュリティグループを構成する
[%collapsible%open]
====
. AWS コンソールで、VPC サービス ページで VPC を見つけて、VPC の *メイン* ルート テーブルを選択し、SDDC に戻るルートを作成します。
. 下部のパネルでルート テーブルを参照し、[ルートの編集] をクリックします。
+
image:fsx-nfs-023.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *ルートの編集* パネルで、*ルートの追加* をクリックし、*トランジット ゲートウェイ* と関連する TGW ID を選択して、SDDC インフラストラクチャの CIDR を入力します。  *変更を保存*をクリックします。
+
image:fsx-nfs-024.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 次のステップでは、関連付けられた VPC 内のセキュリティ グループが、SDDC グループ CIDR の正しい受信ルールで更新されていることを確認します。
. SDDC インフラストラクチャの CIDR ブロックを使用して受信ルールを更新します。
+
image:fsx-nfs-025.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

+

NOTE: 接続の問題を回避するために、VPC (FSx ONTAP が存在する場所) のルート テーブルが更新されていることを確認します。

+

NOTE: NFS トラフィックを受け入れるようにセキュリティ グループを更新します。



これは、適切な SDDC への接続を準備するための最後の手順です。ファイル システムを構成し、ルートを追加し、セキュリティ グループを更新したら、データストアをマウントします。

====
.ステップ6: NFSボリュームをデータストアとしてSDDCクラスタに接続する
[%collapsible%open]
====
ファイル システムがプロビジョニングされ、接続が確立されたら、VMware Cloud Console にアクセスして NFS データストアをマウントします。

. VMC コンソールで、SDDC の *ストレージ* タブを開きます。
+
image:fsx-nfs-027.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *ATTACH DATASTORE* をクリックし、必要な値を入力します。
+

NOTE: NFS サーバー アドレスは、AWS コンソール内の FSx > ストレージ仮想マシン タブ > エンドポイントで確認できる NFS IP アドレスです。

+
image:fsx-nfs-028.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. データストアをクラスターに接続するには、「*データストアの接続*」をクリックします。
+
image:fsx-nfs-029.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 以下に示すように vCenter にアクセスして NFS データストアを検証します。
+
image:fsx-nfs-030.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



====