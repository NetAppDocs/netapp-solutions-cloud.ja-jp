---
sidebar: sidebar 
permalink: vmware/vmw-aws-vmc-dro.html 
keywords: NetApp Solutions, hybrid, multicloud, multi cloud, hyperscalers, vmware, disaster recovery orchestrator, DRO 
summary:  
---
= TR-4955: FSx ONTAPと VMC を使用した災害復旧 (AWS VMware Cloud)
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ディザスタ リカバリ オーケストレーター (DRO、UI 付きのスクリプト ソリューション) を使用すると、オンプレミスから FSx ONTAPに複製されたワークロードをシームレスにリカバリできます。  DROは、 SnapMirrorレベルからVMCへのVM登録、そしてNSX-T上のネットワークマッピングまで、リカバリを自動化します。この機能はすべてのVMC環境に含まれています。

ニヤズ・モハメド、 NetApp



== 概要

クラウドへの災害復旧は、サイトの停止やデータ破損イベント (ランサムウェアなど) からワークロードを保護する、回復力がありコスト効率に優れた方法です。  NetApp SnapMirrorテクノロジーを使用すると、オンプレミスの VMware ワークロードを AWS で実行されている FSx ONTAPに複製できます。

ディザスタ リカバリ オーケストレーター (DRO、UI 付きのスクリプト ソリューション) を使用すると、オンプレミスから FSx ONTAPに複製されたワークロードをシームレスにリカバリできます。  DROは、 SnapMirrorレベルからVMCへのVM登録、そしてNSX-T上のネットワークマッピングまで、リカバリを自動化します。この機能はすべてのVMC環境に含まれています。

image:dro-vmc-001.png["この図は、オンプレミスのデータセンター、VMware Cloud on AWS SDDC インスタンス、およびAmazon FSx ONTAP間の構造と相互接続を示しています。これには、 SnapMirrorレプリケーション、DRaaS Ops トラフィック、インターネットまたは直接接続、VMware Transit Connect が含まれます。"]



== 開始



=== VMware Cloud on AWS の導入と構成

link:https://www.vmware.com/products/vmc-on-aws.html["VMware Cloud on AWS"^]AWS エコシステム内の VMware ベースのワークロードにクラウドネイティブのエクスペリエンスを提供します。各 VMware ソフトウェア定義データセンター (SDDC) は Amazon Virtual Private Cloud (VPC) で実行され、完全な VMware スタック (vCenter Server を含む)、NSX-T ソフトウェア定義ネットワーク、vSAN ソフトウェア定義ストレージ、およびワークロードにコンピューティング リソースとストレージ リソースを提供する 1 つ以上の ESXi ホストを提供します。 AWS上でVMC環境を構成するには、次の手順に従ってください。link:vmw-aws-vmc-setup.html["リンク"^] 。パイロットライト クラスターは DR 目的にも使用できます。


NOTE: 最初のリリースでは、DRO は既存のパイロットライト クラスターをサポートします。オンデマンド SDDC 作成は、今後のリリースで利用可能になります。



=== FSx ONTAP のプロビジョニングと構成

Amazon FSx ONTAP は、人気のNetApp ONTAPファイルシステム上に構築された、信頼性が高く、スケーラブルで、高性能かつ機能豊富なファイルストレージを提供するフルマネージドサービスです。この手順に従ってくださいlink:vmw-aws-vmc-nfs-ds-overview.html["リンク"^]FSx ONTAP をプロビジョニングおよび構成します。



=== SnapMirrorをFSx ONTAPに導入して設定する

次のステップでは、 NetApp BlueXPを使用して、AWS インスタンス上でプロビジョニングされた FSx ONTAPを検出し、適切な頻度とNetApp Snapshot コピー保持期間で、必要なデータストア ボリュームをオンプレミス環境から FSx ONTAPに複製します。

image:dro-vmc-002.png["このグラフィックは、有効なサービス間のさまざまな相互作用を示すBlueXP Canvas 関係マップを表しています。"]

BlueXPを設定するには、このリンクの手順に従ってください。このリンクに従って、 NetApp ONTAP CLI を使用してレプリケーションをスケジュールすることもできます。


NOTE: SnapMirror関係は前提条件であり、事前に作成する必要があります。



== DROのインストール

DRO を開始するには、指定された EC2 インスタンスまたは仮想マシンで Ubuntu オペレーティング システムを使用して、前提条件を満たしていることを確認します。次にパッケージをインストールします。



=== 前提条件

* ソースおよびターゲットの vCenter およびストレージ システムへの接続が存在することを確認します。
* DNS 名を使用している場合は、DNS 解決を実施する必要があります。それ以外の場合は、vCenter およびストレージ システムに IP アドレスを使用する必要があります。
* ルート権限を持つユーザーを作成します。  EC2 インスタンスで sudo を使用することもできます。




=== OSの要件

* Ubuntu 20.04 (LTS)、最低 2GB および 4 つの vCPU
* 指定されたエージェント VM に次のパッケージをインストールする必要があります。
+
** Docker
** Docker-compose
** Jq




権限を変更する `docker.sock`： `sudo chmod 666 /var/run/docker.sock` 。


NOTE: その `deploy.sh`スクリプトは必要な前提条件をすべて実行します。



=== パッケージをインストールする

. 指定された仮想マシンにインストール パッケージをダウンロードします。
+
[listing]
----
git clone https://github.com/NetApp/DRO-AWS.git
----
+

NOTE: エージェントはオンプレミスまたは AWS VPC 内にインストールできます。

. パッケージを解凍し、デプロイメント スクリプトを実行して、ホスト IP (例: 10.10.10.10) を入力します。
+
[listing]
----
tar xvf DRO-prereq.tar
----
. ディレクトリに移動し、次のようにデプロイ スクリプトを実行します。
+
[listing]
----
sudo sh deploy.sh
----
. 次の方法で UI にアクセスします。
+
[listing]
----
https://<host-ip-address>
----
+
次のデフォルトの資格情報を使用します。

+
[listing]
----
Username: admin
Password: admin
----



NOTE: パスワードは「パスワードの変更」オプションを使用して変更できます。

image:dro-vmc-003.png["Disaster Recovery Orchestrator のログイン画面。"]



== DRO構成

FSx ONTAPと VMC が適切に構成されたら、FSx ONTAP上の読み取り専用SnapMirrorコピーを使用してオンプレミスのワークロードを VMC に自動的にリカバリするように DRO の構成を開始できます。

NetApp、DRO エージェントがオンプレミスのコンポーネントだけでなく、FSx ONTAPや VMC リソースともネットワークを介して通信できるように、DRO エージェントを AWS に導入し、さらに FSx ONTAPが導入されているのと同じ VPC (ピア接続も可能) にも導入することを推奨しています。

最初のステップは、オンプレミスとクラウドのリソース (vCenter とストレージの両方) を検出して DRO に追加することです。サポートされているブラウザで DRO を開き、デフォルトのユーザー名とパスワード (admin/admin) を使用して、サイトを追加します。検出オプションを使用してサイトを追加することもできます。次のプラットフォームを追加します。

* オンプレミス
+
** オンプレミスの vCenter
** ONTAPストレージシステム


* クラウド
+
** VMC vCenter
** FSx ONTAP




image:dro-vmc-004.png["一時的なプレースホルダー画像の説明。"]

image:dro-vmc-005.png["ソース サイトと宛先サイトを含む DRO サイトの概要ページ。"]

追加されると、DRO は自動検出を実行し、ソース ストレージから FSx ONTAPに対応するSnapMirrorレプリカを持つ VM を表示します。  DRO は、VM で使用されるネットワークとポートグループを自動的に検出し、それらを入力します。

image:dro-vmc-006.png["219 台の仮想マシンと 10 個のデータストアを含む自動検出画面。"]

次のステップは、必要な VM を機能グループにグループ化し、リソース グループとして機能するようにすることです。



=== リソースのグループ化

プラットフォームを追加したら、回復する VM をリソース グループにグループ化できます。  DRO リソース グループを使用すると、依存する VM のセットを、ブート順序、ブート遅延、および回復時に実行できるオプションのアプリケーション検証を含む論理グループにグループ化できます。

リソース グループの作成を開始するには、次の手順を実行します。

. *リソース グループ* にアクセスし、*新しいリソース グループの作成* をクリックします。
. *新しいリソース グループ* の下で、ドロップダウンからソース サイトを選択し、*作成* をクリックします。
. *リソース グループの詳細* を入力し、[続行] をクリックします。
. 検索オプションを使用して適切な VM を選択します。
. 選択した VM のブート順序とブート遅延 (秒) を選択します。各 VM を選択し、その優先順位を設定することで、電源オン シーケンスの順序を設定します。すべての VM のデフォルト値は 3 です。
+
オプションは次のとおりです。

+
1 – 最初にパワーオンする仮想マシン 3 – デフォルト 5 – 最後にパワーオンする仮想マシン

. *リソース グループの作成*をクリックします。


image:dro-vmc-007.png["2 つのエントリ (Test と DemoRG1) を含むリソース グループ リストのスクリーンショット。"]



=== レプリケーションプラン

災害が発生した場合にアプリケーションを回復するための計画が必要です。ドロップダウンからソースとターゲットの vCenter プラットフォームを選択し、このプランに含めるリソース グループと、アプリケーションを復元してパワーオンする方法のグループ化 (たとえば、ドメイン コントローラ、次に Tier 1、次に Tier 2 など) を選択します。このような計画は、青写真と呼ばれることもあります。リカバリ プランを定義するには、[*レプリケーション プラン*] タブに移動し、[*新しいレプリケーション プラン*] をクリックします。

レプリケーション プランの作成を開始するには、次の手順を実行します。

. *レプリケーション プラン*にアクセスし、*新しいレプリケーション プランの作成*をクリックします。
+
image:dro-vmc-008.png["DemoRP という 1 つのプランを含むレプリケーション プラン画面のスクリーンショット。"]

. *新しいレプリケーション プラン* で、プランの名前を指定し、ソース サイト、関連付けられた vCenter、宛先サイト、および関連付けられた vCenter を選択して、リカバリ マッピングを追加します。
+
image:dro-vmc-009.png["リカバリ マッピングを含むレプリケーション プランの詳細のスクリーンショット。"]

. リカバリ マッピングが完了したら、クラスター マッピングを選択します。
+
image:dro-vmc-010.png["一時的なプレースホルダー画像の説明。"]

. *リソース グループの詳細*を選択し、*続行*をクリックします。
. リソース グループの実行順序を設定します。このオプションを使用すると、複数のリソース グループが存在する場合に操作のシーケンスを選択できます。
. 完了したら、適切なセグメントへのネットワーク マッピングを選択します。セグメントはすでに VMC 内でプロビジョニングされているはずなので、適切なセグメントを選択して VM をマップします。
. VM の選択に基づいて、データストア マッピングが自動的に選択されます。
+

NOTE: SnapMirrorはボリューム レベルで行われます。したがって、すべての VM がレプリケーション先にレプリケートされます。データストアの一部であるすべての VM を選択してください。選択されていない場合は、レプリケーション プランの一部である VM のみが処理されます。

+
image:dro-vmc-011.png["一時的なプレースホルダー画像の説明。"]

. VM の詳細では、オプションで VM の CPU および RAM パラメータのサイズを変更できます。これは、大規模な環境を小規模なターゲット クラスターに回復する場合や、1 対 1 の物理 VMware インフラストラクチャをプロビジョニングせずに DR テストを実施する場合に非常に役立ちます。また、リソース グループ全体で選択したすべての VM のブート順序とブート遅延 (秒) を変更することもできます。リソース グループのブート順序の選択時に選択したものから変更が必要な場合、ブート順序を変更するための追加オプションがあります。デフォルトでは、リソース グループの選択時に選択されたブート順序が使用されますが、この段階で変更を実行することもできます。
+
image:dro-vmc-012.png["一時的なプレースホルダー画像の説明。"]

. *レプリケーション プランの作成*をクリックします。
+
image:dro-vmc-013.png["一時的なプレースホルダー画像の説明。"]



レプリケーション プランが作成された後、要件に応じて、フェールオーバー オプション、テスト フェールオーバー オプション、または移行オプションを実行できます。フェイルオーバーおよびテストフェイルオーバーのオプション中は、最新のSnapMirrorスナップショット コピーが使用されるか、または特定のスナップショット コピーをポイントインタイム スナップショット コピーから選択できます ( SnapMirrorの保持ポリシーに従って)。ランサムウェアなどの破損イベントに直面していて、最新のレプリカがすでに侵害されたり暗号化されたりしている場合は、ポイントインタイム オプションが非常に役立ちます。 DRO は利用可能なすべての時点を表示します。レプリケーション プランで指定された構成でフェイルオーバーまたはテスト フェイルオーバーをトリガーするには、[フェイルオーバー] または [フェイルオーバーのテスト] をクリックします。

image:dro-vmc-014.png["一時的なプレースホルダー画像の説明。"] image:dro-vmc-015.png["この画面では、ボリューム スナップショットの詳細が提供され、最新のスナップショットを使用するか、特定のスナップショットを選択するかを選択できます。"]

レプリケーション プランはタスク メニューで監視できます。

image:dro-vmc-016.png["タスク メニューには、レプリケーション プランのすべてのジョブとオプションが表示され、ログも表示できます。"]

フェイルオーバーがトリガーされると、回復された項目が VMC vCenter (VM、ネットワーク、データストア) に表示されます。デフォルトでは、VM はワークロード フォルダーに回復されます。

image:dro-vmc-017.png["一時的なプレースホルダー画像の説明。"]

フェイルバックはレプリケーション プラン レベルでトリガーできます。テストフェイルオーバーの場合、ティアダウン オプションを使用して変更をロールバックし、 FlexClone関係を削除できます。フェイルオーバーに関連するフェイルバックは 2 段階のプロセスです。レプリケーション プランを選択し、*逆データ同期* を選択します。

image:dro-vmc-018.png["逆データ同期オプションを含むドロップダウンを含むレプリケーション プランの概要のスクリーンショット。"] image:dro-vmc-019.png["一時的なプレースホルダー画像の説明。"]

完了したら、フェイルバックをトリガーして元の運用サイトに戻ることができます。

image:dro-vmc-020.png["フェールバック オプションを含むドロップダウンを含むレプリケーション プランの概要のスクリーンショット。"] image:dro-vmc-021.png["元の運用サイトが稼働している DRO 概要ページのスクリーンショット。"]

NetApp BlueXPから、適切なボリューム (読み取り/書き込みボリュームとして VMC にマップされたもの) のレプリケーションの正常性が失われていることがわかります。テスト フェイルオーバー中、DRO は宛先ボリュームまたはレプリカ ボリュームをマップしません。代わりに、必要なSnapMirror (または Snapshot) インスタンスのFlexCloneコピーを作成し、 FlexCloneインスタンスを公開します。これにより、 FSx ONTAPの追加の物理容量が消費されることはありません。このプロセスにより、ボリュームが変更されず、DR テストまたはトリアージ ワークフロー中でもレプリカ ジョブが続行できるようになります。さらに、このプロセスにより、エラーが発生した場合や破損したデータが回復された場合に、レプリカが破壊されるリスクなしに回復をクリーンアップできるようになります。

image:dro-vmc-022.png["一時的なプレースホルダー画像の説明。"]



=== ランサムウェアからの回復

ランサムウェアからの回復は困難な作業になる可能性があります。具体的には、IT 組織にとって、安全な復帰ポイントがどこにあるかを正確に特定することは困難であり、また、それが特定された後、たとえば休眠中のマルウェアや脆弱なアプリケーションによる再発する攻撃から回復したワークロードを保護することも困難です。

DRO は、利用可能な任意の時点からシステムを回復できるようにすることで、これらの懸念に対処します。また、アプリケーションが南北トラフィックにさらされていない場所でも機能し、相互に通信できるように、ワークロードを機能しながらも分離されたネットワークにリカバリすることもできます。これにより、セキュリティ チームは安全な場所でフォレンジックを実施し、隠れたマルウェアや潜伏中のマルウェアがないことを確認できます。



== 利点

* 効率的で回復力のあるSnapMirrorレプリケーションの使用。
* スナップショット コピーの保持により、利用可能な任意の時点にリカバリできます。
* ストレージ、コンピューティング、ネットワーク、アプリケーションの検証手順から数百から数千の VM を回復するために必要なすべての手順を完全に自動化します。
* 複製されたボリュームを変更しない方法を使用した、 ONTAP FlexCloneテクノロジーによるワークロードのリカバリ。
+
** ボリュームまたはスナップショット コピーのデータ破損のリスクを回避します。
** DR テスト ワークフロー中のレプリケーションの中断を回避します。
** DevTest、セキュリティ テスト、パッチまたはアップグレード テスト、修復テストなど、DR 以外のワークフローにクラウド コンピューティング リソースで DR データを使用する可能性。


* CPU と RAM の最適化により、より小規模なコンピューティング クラスターへのリカバリが可能になり、クラウド コストが削減されます。

