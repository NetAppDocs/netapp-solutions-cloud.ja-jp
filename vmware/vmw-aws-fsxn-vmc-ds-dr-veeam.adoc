---
sidebar: sidebar 
permalink: vmware/vmw-aws-fsxn-vmc-ds-dr-veeam.html 
keywords: disaster recovery, vmc, vmware cloud, aws, amazon web services, fsxn, FSx ONTAP, FSx ONTAP, disaster recovery, dr, veeam, replication 
summary:  
---
= Veeam Replication と FSx ONTAPを使用して VMware Cloud on AWS への災害復旧を行う
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Amazon FSx ONTAPと VMware Cloud on AWS の統合は、SDDC 内のクラスターに接続できる NetApp のONTAPファイルシステム上に構築された AWS 管理の外部 NFS データストアです。コンピューティング リソースとは独立して拡張できる、柔軟で高性能な仮想化ストレージ インフラストラクチャを顧客に提供します。



== 概要

VMware Cloud on AWS SDDC を災害復旧ターゲットとして使用することを検討しているお客様の場合、VM レプリケーション機能を提供する検証済みのサードパーティ ソリューションを使用して、FSx ONTAPデータストアでオンプレミスからデータを複製できます。  FSx ONTAPデータストアを追加することで、ストレージに対応するためだけに膨大な数の ESXi ホストを使用して VMware Cloud on AWS SDDC を構築するよりもコストを最適化した展開が可能になります。

このアプローチは、VM レプリカをホストするために、VMC のパイロット ライト クラスタと FSx ONTAPデータストアを使用するのにも役立ちます。レプリケーション プランを正常にフェイルオーバーすることで、同じプロセスを VMware Cloud on AWS への移行オプションとして拡張することもできます。



== 問題の説明

このドキュメントでは、FSx ONTAPデータストアと Veeam Backup and replication を使用して、VM レプリケーション機能によりオンプレミスの VMware VM から VMware Cloud on AWS へのディザスタ リカバリを設定する方法について説明します。

Veeam Backup & Replication を使用すると、災害復旧 (DR) のためのオンサイトおよびリモートのレプリケーションが可能になります。仮想マシンが複製されると、Veeam Backup & Replication は、ターゲットの VMware Cloud on AWS SDDC クラスター上にネイティブ VMware vSphere 形式で仮想マシンの正確なコピーを作成し、そのコピーを元の仮想マシンと同期した状態に保ちます。

レプリケーションでは、起動準備完了状態の VM のコピーが存在するため、最適な復旧時間目標 (RTO) 値が提供されます。このレプリケーション メカニズムにより、災害発生時にワークロードを VMware Cloud on AWS SDDC で迅速に開始できるようになります。 Veeam Backup & Replication ソフトウェアは、WAN および低速接続を介したレプリケーションのトラフィック転送も最適化します。さらに、重複したデータ ブロック、ゼロ データ ブロック、スワップ ファイル、除外された VM ゲスト OS ファイルも除外し、レプリカ トラフィックを圧縮します。

レプリケーション ジョブがネットワーク帯域幅全体を消費するのを防ぐために、WAN アクセラレータとネットワーク スロットリング ルールを導入できます。 Veeam Backup & Replication のレプリケーション プロセスはジョブ駆動型であり、レプリケーション ジョブを構成することによってレプリケーションが実行されます。災害が発生した場合、フェイルオーバーをトリガーしてレプリカ コピーにフェイルオーバーすることで VM を復旧できます。

フェイルオーバーが実行されると、複製された VM が元の VM の役割を引き継ぎます。フェイルオーバーは、レプリカの最新の状態またはその既知の復元ポイントのいずれかに対して実行できます。これにより、必要に応じてランサムウェアの回復や分離されたテストが可能になります。  Veeam Backup & Replication では、フェイルオーバーとフェイルバックは一時的な中間ステップであり、後で最終的に決定する必要があります。  Veeam Backup & Replication は、さまざまな災害復旧シナリオを処理するための複数のオプションを提供します。

image:dr-veeam-fsx-001.png["Veeam Replication と FSx ONTAP for VMC を使用した DR シナリオの図"]



== ソリューションの展開



=== 高レベルの手順

. Veeam Backup and Replication ソフトウェアは、適切なネットワーク接続を備えたオンプレミス環境で実行されています。
. VMware Cloud on AWS を構成するには、VMware Cloud Tech Zone の記事を参照してください。link:https://vmc.techzone.vmware.com/fsx-guide["VMware Cloud on AWS とAmazon FSx ONTAP の統合の導入ガイド"]展開するには、VMware Cloud on AWS SDDC と FSx ONTAP をNFS データストアとして構成します。 (最小限の構成でセットアップされたパイロットライト環境は、DR の目的で使用できます。インシデント発生時には VM はこのクラスターにフェールオーバーされ、追加のノードを追加できます。
. Veeam Backup and Replication を使用して VM レプリカを作成するためのレプリケーション ジョブを設定します。
. フェイルオーバー プランを作成し、フェイルオーバーを実行します。
. 災害イベントが完了し、プライマリ サイトが稼働したら、本番環境の VM に切り替えます。




=== VMC および FSx ONTAPデータストアへの Veeam VM レプリケーションの前提条件

. Veeam Backup & Replication バックアップ VM がソース vCenter とターゲット VMware cloud on AWS SDDC クラスターに接続されていることを確認します。
. バックアップ サーバーは、短い名前を解決し、ソース vCenter とターゲット vCenter に接続できる必要があります。
. ターゲットFSx ONTAPデータストアには、複製されたVMのVMDKを保存するのに十分な空き容量が必要です。


詳細については、「考慮事項と制限事項」を参照してください。link:https://helpcenter.veeam.com/docs/backup/vsphere/replica_limitations.html?ver=120["ここをクリックしてください。"] 。



=== 導入環境の詳細

.ステップ1: VMを複製する
[%collapsible%open]
====
Veeam Backup & Replication は VMware vSphere のスナップショット機能を活用し、レプリケーション中に Veeam Backup & Replication は VMware vSphere に VM スナップショットの作成を要求します。  VM スナップショットは、仮想ディスク、システム状態、構成などを含む VM の特定時点のコピーです。  Veeam Backup & Replication は、スナップショットをレプリケーションのデータ ソースとして使用します。

VM をレプリケートするには、次の手順に従います。

. Veeam Backup & Replication コンソールを開きます。
. ホーム ビューで、レプリケーション ジョブ > 仮想マシン > VMware vSphere を選択します。
. ジョブ名を指定し、適切な詳細制御チェックボックスを選択します。[Next]をクリックします。
+
** オンプレミスと AWS 間の接続の帯域幅が制限されている場合は、レプリカ シーディング チェックボックスをオンにします。
** VMware Cloud on AWS SDDC 上のセグメントがオンプレミスのサイト ネットワークのセグメントと一致しない場合は、[ネットワークの再マッピング（異なるネットワークを持つ AWS VMC サイトの場合）] チェック ボックスをオンにします。
** オンプレミスの本番サイトの IP アドレス指定スキームが AWS VMC サイトのスキームと異なる場合は、[レプリカ再 IP (IP アドレス指定スキームが異なる DR サイト用)] チェック ボックスをオンにします。
+
image:dr-veeam-fsx-002.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



. *仮想マシン* ステップで、VMware Cloud on AWS SDDC に接続された FSx ONTAPデータストアに複製する必要がある仮想マシンを選択します。使用可能な vSAN データストアの容量を満たすために、仮想マシンを vSAN 上に配置できます。パイロット ライト クラスターでは、3 ノード クラスターの使用可能な容量が制限されます。残りのデータは FSx ONTAPデータストアに複製できます。 [追加] をクリックし、[オブジェクトの追加] ウィンドウで必要な VM または VM コンテナを選択して [追加] をクリックします。*次へ*をクリックします。
+
image:dr-veeam-fsx-003.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. その後、宛先として VMware Cloud on AWS SDDC クラスタ/ホストを選択し、VM レプリカ用の適切なリソース プール、VM フォルダ、および FSx ONTAPデータストアを選択します。次に、[次へ]をクリックします。
+
image:dr-veeam-fsx-004.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 次の手順では、必要に応じて、ソース仮想ネットワークと宛先仮想ネットワーク間のマッピングを作成します。
+
image:dr-veeam-fsx-005.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. *ジョブ設定* ステップで、VM レプリカのメタデータ、保持ポリシーなどを保存するバックアップ リポジトリを指定します。
. *データ転送*手順で*ソース*および*ターゲット*プロキシ サーバーを更新し、*自動*選択 (デフォルト) のままにして、*直接*オプションを選択したままにして、*次へ*をクリックします。
. *ゲスト処理*のステップで、必要に応じて*アプリケーション対応処理を有効にする*オプションを選択します。*次へ*をクリックします。
+
image:dr-veeam-fsx-006.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 定期的に実行するレプリケーション ジョブを実行するには、レプリケーション スケジュールを選択します。
. ウィザードの*概要*手順で、レプリケーション ジョブの詳細を確認します。ウィザードを閉じた直後にジョブを開始するには、[[完了] をクリックしたときにジョブを実行する] チェック ボックスをオンにします。それ以外の場合は、チェック ボックスをオフのままにします。次に、[完了] をクリックしてウィザードを閉じます。
+
image:dr-veeam-fsx-007.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



レプリケーション ジョブが開始されると、指定されたサフィックスを持つ VM が宛先 VMC SDDC クラスタ/ホストに配置されます。

image:dr-veeam-fsx-008.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

Veeamレプリケーションの詳細については、以下を参照してください。link:https://helpcenter.veeam.com/docs/backup/vsphere/replication_process.html?ver=120["レプリケーションの仕組み"] 。

====
.ステップ2: フェイルオーバー計画を作成する
[%collapsible%open]
====
初期レプリケーションまたはシードが完了したら、フェールオーバー プランを作成します。フェイルオーバー プランは、依存する VM のフェイルオーバーを 1 つずつ、またはグループとして自動的に実行するのに役立ちます。フェイルオーバー プランは、ブートの遅延を含め、VM が処理される順序の青写真です。フェールオーバー プランは、重要な依存 VM がすでに実行されていることを確認するのにも役立ちます。

プランを作成するには、「レプリカ」という新しいサブセクションに移動し、「フェールオーバー プラン」を選択します。適切な VM を選択します。  Veeam Backup & Replication は、この時点に最も近い復元ポイントを探し、それを使用して VM レプリカを起動します。


NOTE: フェールオーバー プランは、初期レプリケーションが完了し、VM レプリカが準備完了状態になった後にのみ追加できます。


NOTE: フェイルオーバー プランの実行時に同時に起動できる VM の最大数は 10 です。


NOTE: フェールオーバー プロセス中、ソース VM の電源はオフになりません。

*フェイルオーバー プラン* を作成するには、次の手順を実行します。

. ホーム ビューで、*フェイルオーバー プラン > VMware vSphere* を選択します。
. 次に、プランの名前と説明を入力します。必要に応じて、フェイルオーバー前およびフェイルオーバー後のスクリプトを追加できます。たとえば、複製された VM を起動する前に VM をシャットダウンするスクリプトを実行します。
+
image:dr-veeam-fsx-009.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. VM を計画に追加し、アプリケーションの依存関係を満たすように VM のブート順序とブート遅延を変更します。
+
image:dr-veeam-fsx-010.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



レプリケーションジョブの作成に関する追加情報については、以下を参照してください。link:https://helpcenter.veeam.com/docs/backup/vsphere/replica_job.html?ver=120["レプリケーションジョブの作成"] 。

====
.ステップ3: フェイルオーバープランを実行する
[%collapsible%open]
====
フェイルオーバー中、運用サイトのソース VM は災害復旧サイトのレプリカに切り替えられます。フェイルオーバー プロセスの一環として、Veeam Backup & Replication は VM レプリカを必要な復元ポイントに復元し、すべての I/O アクティビティをソース VM からそのレプリカに移動します。レプリカは災害時だけでなく、DR 訓練のシミュレーションにも使用できます。フェールオーバー シミュレーション中、ソース VM は実行を継続します。必要なテストがすべて実行されたら、フェイルオーバーを元に戻して通常の操作に戻ることができます。


NOTE: DR ドリル中の IP 競合を回避するために、ネットワーク セグメンテーションが確実に実施されていることを確認してください。

フェールオーバー プランを開始するには、[フェールオーバー プラン] タブをクリックし、フェールオーバー プランを右クリックするだけです。 *開始*を選択します。これにより、VM レプリカの最新の復元ポイントを使用してフェイルオーバーが行われます。  VM レプリカの特定の復元ポイントにフェールオーバーするには、[開始] を選択します。

image:dr-veeam-fsx-011.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-veeam-fsx-012.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

VM レプリカの状態が「準備完了」から「フェイルオーバー」に変わり、VM は宛先の VMware Cloud on AWS SDDC クラスタ/ホストで起動します。

image:dr-veeam-fsx-013.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

フェイルオーバーが完了すると、VM のステータスが「フェイルオーバー」に変わります。

image:dr-veeam-fsx-014.png["入出力ダイアログまたは書かれたコンテンツを示す図"]


NOTE: Veeam Backup & Replication は、レプリカが準備完了状態に戻るまで、ソース VM のすべてのレプリケーション アクティビティを停止します。

フェイルオーバープランの詳細については、以下を参照してください。link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_plan.html?ver=120["フェイルオーバー計画"] 。

====
.ステップ4: 本番サイトへのフェイルバック
[%collapsible%open]
====
フェイルオーバー プランが実行中の場合、それは中間ステップとみなされ、要件に基づいて確定する必要があります。オプションには次のものがあります。

* *本番環境へのフェールバック* - 元の VM に切り替えて、VM レプリカの実行中に行われたすべての変更を元の VM に転送します。



NOTE: フェイルバックを実行すると、変更は転送されるだけで公開されません。元の VM が期待どおりに動作していることが確認されたら、*フェイルバックのコミット* を選択するか、元の VM が期待どおりに動作していない場合は、*フェイルバックを元に戻す* を選択して VM レプリカに戻ります。

* *フェイルオーバーを元に戻す* - 元の VM に切り替えて、VM レプリカの実行中に行われたすべての変更を破棄します。
* *永続的なフェイルオーバー* - 元の VM から VM レプリカに永続的に切り替え、このレプリカを元の VM として使用します。


このデモでは、本番環境へのフェールバックが選択されました。ウィザードの宛先ステップで元の VM へのフェールバックが選択され、「復元後に VM をパワーオンする」チェックボックスが有効になりました。

image:dr-veeam-fsx-015.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-veeam-fsx-016.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

フェイルバックコミットは、フェイルバック操作を完了する方法の 1 つです。フェイルバックがコミットされると、フェイルバックされた VM (運用 VM) に送信された変更が期待どおりに機能していることが確認されます。コミット操作の後、Veeam Backup & Replication は実稼働 VM のレプリケーション アクティビティを再開します。

フェイルバックプロセスの詳細については、Veeamのドキュメントを参照してください。link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_failback.html?ver=120["レプリケーションのフェイルオーバーとフェイルバック"] 。

image:dr-veeam-fsx-017.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-veeam-fsx-018.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

運用環境へのフェイルバックが成功すると、VM はすべて元の運用サイトに復元されます。

image:dr-veeam-fsx-019.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

====


== まとめ

FSx ONTAPデータストア機能により、Veeam または検証済みのサードパーティ ツールは、VM レプリカ コピーに対応するためだけにクラスター内に多数のホストを立ち上げることなく、Pilot light クラスターを使用して低コストの DR ソリューションを提供できるようになります。これにより、調整されカスタマイズされた災害復旧計画を処理するための強力なソリューションが提供され、DR のニーズを満たすために社内の既存のバックアップ製品を再利用することも可能になり、オンプレミスの DR データセンターを終了してクラウドベースの災害復旧が可能になります。フェイルオーバーは、計画的なフェイルオーバーとして実行することも、災害発生時にボタンをクリックするだけでフェイルオーバーを実行することもでき、DR サイトをアクティブ化する決定が下されます。

このプロセスについて詳しく知りたい場合は、詳細なウォークスルー ビデオをご覧ください。

video::15fed205-8614-4ef7-b2d0-b061015e925a[panopto,width=Video walkthrough of the solution]